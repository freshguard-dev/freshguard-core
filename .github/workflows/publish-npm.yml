name: Publish to NPM

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  id-token: write  # Required for OIDC
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: freshguard_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Build packages
        run: pnpm build

      - name: Run full test suite
        run: pnpm test:coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/freshguard_test

      - name: Security audit
        run: |
          # Known acceptable advisories that cannot be fixed upstream.
          # These are all dev or docs-only (website workspace); none ship in the published package.
          #   GHSA-6pfh-p556-v868 â€” pnpm ZIP slip (dev dep, awaiting stable upstream fix)
          #   GHSA-2g4f-4pwh-qvx6 â€” ajv ReDoS via $data option (eslint + website/docusaurus;
          #                          $data option never enabled; note: pnpm --prod includes the
          #                          website workspace's prod deps, hence ajv appears even there)
          KNOWN_OK="GHSA-6pfh-p556-v868 GHSA-2g4f-4pwh-qvx6"

          run_audit() {
            local label="$1"; shift
            echo "ğŸ” $label"
            pnpm audit "$@" > /tmp/audit-output.txt 2>&1 && return 0
            FOUND=$(grep -oE "GHSA-[a-z0-9-]+" /tmp/audit-output.txt | sort -u)
            for id in $FOUND; do
              if ! echo "$KNOWN_OK" | grep -q "$id"; then
                echo "âŒ Unknown vulnerability: $id"
                cat /tmp/audit-output.txt
                return 1
              fi
            done
            echo "âœ… All issues are known acceptable dev/docs-only vulnerabilities (not in published package)"
          }

          run_audit "Checking production dependencies..." --audit-level moderate --prod
          run_audit "Checking all dependencies (including dev)..." --audit-level moderate
          echo "   Published package is clean âœ…"

      - name: Install security scanning tools
        run: |
          # Install Syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate Software Bill of Materials (SBOM)
        run: |
          # Generate SBOM using Syft (reliable, no npm dependency)
          echo "ğŸ” Generating Software Bill of Materials..."

          # Generate SBOM in multiple formats using Syft
          syft packages . -o spdx-json=sbom-spdx.json
          syft packages . -o syft-json=sbom-syft.json

          # Create minimal CycloneDX SBOM manually from package.json
          echo "ğŸ”§ Creating CycloneDX SBOM from package.json..."
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
            const cyclonedx = {
              bomFormat: 'CycloneDX',
              specVersion: '1.4',
              version: 1,
              metadata: {
                timestamp: new Date().toISOString(),
                tools: [{
                  vendor: 'FreshGuard',
                  name: 'manual-sbom-generator',
                  version: '1.0.0'
                }],
                component: {
                  name: pkg.name,
                  version: pkg.version,
                  type: 'library',
                  description: pkg.description,
                  licenses: [{name: pkg.license}]
                }
              },
              components: Object.entries(pkg.dependencies || {}).map(([name, version]) => ({
                name,
                version: version.replace(/[\^~]/, ''),
                type: 'library',
                scope: 'required'
              }))
            };
            require('fs').writeFileSync('sbom-cyclonedx.json', JSON.stringify(cyclonedx, null, 2));
          "

          # Create human-readable SBOM
          echo "# FreshGuard Core - Software Bill of Materials" > SBOM.md
          echo "" >> SBOM.md
          echo "Generated: $(date -u)" >> SBOM.md
          echo "Version: ${GITHUB_REF#refs/tags/v}" >> SBOM.md
          echo "" >> SBOM.md
          echo "## Dependencies" >> SBOM.md
          echo "" >> SBOM.md
          syft packages . -o table >> SBOM.md

          # Validate SBOM files exist
          if [[ ! -f sbom-spdx.json ]] || [[ ! -f sbom-cyclonedx.json ]]; then
            echo "âŒ SBOM generation failed"
            exit 1
          fi
          echo "âœ… SBOM generated successfully"

      - name: Vulnerability scanning
        run: |
          echo "ğŸ” Running vulnerability scans..."

          # Grype for vulnerability scanning
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

          # Scan for vulnerabilities
          grype . --output json --file vulnerability-report.json
          grype . --output table

          # Check for critical vulnerabilities
          CRITICAL_VULNS=$(grype . --output json | jq '.matches[]? | select(.vulnerability.severity == "Critical") | .vulnerability.id' | wc -l)
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_VULNS critical vulnerabilities"
            echo "Please address critical vulnerabilities before publishing"
            exit 1
          fi
          echo "âœ… No critical vulnerabilities found"

      - name: Supply chain security verification
        run: |
          echo "ğŸ” Verifying supply chain security..."

          # Check for suspicious dependencies (production only should be clean)
          echo "ğŸ” Auditing production dependencies for high severity issues..."
          pnpm audit --audit-level high --prod

          # Check all dependencies (may have the known pnpm dev dependency issue)
          echo "ğŸ” Auditing all dependencies..."
          pnpm audit --audit-level high || {
            echo "Checking if audit failure is due to known pnpm issue..."
            if pnpm audit --audit-level high 2>&1 | grep -q "GHSA-6pfh-p556-v868"; then
              echo "âœ… Only known pnpm ZIP slip vulnerability (dev dependency)"
            else
              echo "âŒ High severity vulnerabilities found"
              pnpm audit --audit-level high
              exit 1
            fi
          }

          # Verify package integrity
          pnpm install --frozen-lockfile --ignore-scripts

          # Check for truly suspicious patterns (refined to reduce false positives)
          MALICIOUS_PATTERNS=(
            "bitcoin.*wallet"
            "crypto.*miner.*start"
            "monero.*mining"
            "execSync.*rm.*rf"
            "spawn.*rm.*-rf"
            "eval.*require"
            "new.*Function.*require"
            "process\.exit.*999"
          )

          echo "ğŸ” Scanning for malicious code patterns..."
          SUSPICIOUS_FOUND=false

          for pattern in "${MALICIOUS_PATTERNS[@]}"; do
            # Exclude known safe directories (tests, benchmarks, security tools)
            if grep -r -E "$pattern" node_modules/ \
              --include="*.js" \
              --exclude-dir="test*" \
              --exclude-dir="benchmark*" \
              --exclude-dir="*eslint*" \
              --exclude="*test*" \
              --exclude="*spec*" 2>/dev/null | head -3; then
              echo "ğŸš¨ Found potentially malicious pattern: $pattern"
              SUSPICIOUS_FOUND=true
            fi
          done

          if [ "$SUSPICIOUS_FOUND" = false ]; then
            echo "âœ… No malicious patterns detected"
          else
            echo "âš ï¸ Manual review recommended for flagged patterns"
          fi

          echo "âœ… Supply chain verification complete"

      - name: Verify open-core compliance
        run: |
          echo "ğŸ” Final verification of open-core compliance..."

          # Check for forbidden multi-tenant patterns
          FORBIDDEN_PATTERNS=(
            "workspaceId"
            "workspace_id"
            "multi.tenant"
            "User.*interface"
            "Workspace.*interface"
            "AuthContext"
          )

          EXIT_CODE=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -r -i "$pattern" src/ --include="*.ts" --include="*.js"; then
              echo "âŒ Found forbidden pattern: $pattern"
              EXIT_CODE=1
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Multi-tenant contamination detected - cannot publish"
            exit 1
          fi

          echo "âœ… Open-core compliance verified"

  publish:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Upgrade npm for OIDC support
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Install package signing tools
        run: |
          # Install cosign for container/artifact signing
          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign
          sudo chmod +x /usr/local/bin/cosign

      - name: Generate and sign package
        run: |
          echo "ğŸ” Generating and signing package..."

          # Create tarball of the package for signing
          pnpm pack

          # Get the generated tarball name
          TARBALL=$(ls *.tgz | head -1)
          echo "Generated tarball: $TARBALL"

          # Sign with cosign using keyless signing (OIDC) and bundle format
          cosign sign-blob --yes "$TARBALL" --bundle "${TARBALL}.cosign.bundle"

          # Verify the signature using bundle
          cosign verify-blob --bundle "${TARBALL}.cosign.bundle" \
            --certificate-identity-regexp=".*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" "$TARBALL"

          echo "âœ… Package signed successfully"

          # Display signature info
          echo "ğŸ“œ Signature files created:"
          ls -la *.bundle

      - name: Extract version from tag
        id: extract_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Publish package
        run: pnpm publish --access public --provenance --no-git-checks

      - name: Copy SBOM and signature files from test job
        run: |
          echo "ğŸ“‹ Copying SBOM and signature files for release..."
          # Note: In a real workflow, you'd use artifacts to transfer files between jobs
          # For now, we'll regenerate the SBOM quickly for the release

          # Install Syft only (no npm tools needed)
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          # Generate SBOM for release using same approach as test job
          syft packages . -o spdx-json=sbom-spdx.json

          # Create CycloneDX SBOM manually from package.json
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
            const cyclonedx = {
              bomFormat: 'CycloneDX',
              specVersion: '1.4',
              version: 1,
              metadata: {
                timestamp: new Date().toISOString(),
                tools: [{
                  vendor: 'FreshGuard',
                  name: 'manual-sbom-generator',
                  version: '1.0.0'
                }],
                component: {
                  name: pkg.name,
                  version: pkg.version,
                  type: 'library',
                  description: pkg.description,
                  licenses: [{name: pkg.license}]
                }
              },
              components: Object.entries(pkg.dependencies || {}).map(([name, version]) => ({
                name,
                version: version.replace(/[\^~]/, ''),
                type: 'library',
                scope: 'required'
              }))
            };
            require('fs').writeFileSync('sbom-cyclonedx.json', JSON.stringify(cyclonedx, null, 2));
          "

          # Create human-readable SBOM for release
          echo "# FreshGuard Core v${{ steps.extract_version.outputs.version }} - Software Bill of Materials" > SBOM.md
          echo "" >> SBOM.md
          echo "**Generated:** $(date -u)" >> SBOM.md
          echo "**Version:** ${{ steps.extract_version.outputs.version }}" >> SBOM.md
          echo "**Package:** @freshguard/freshguard-core" >> SBOM.md
          echo "" >> SBOM.md
          echo "## Security Information" >> SBOM.md
          echo "" >> SBOM.md
          echo "- Package signed with cosign using keyless signing" >> SBOM.md
          echo "- OIDC identity verified through GitHub Actions" >> SBOM.md
          echo "- Vulnerability scanned before release" >> SBOM.md
          echo "- Supply chain verified" >> SBOM.md
          echo "" >> SBOM.md
          echo "## Dependencies" >> SBOM.md
          echo "" >> SBOM.md
          syft packages . -o table >> SBOM.md

          echo "âœ… SBOM prepared for release"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          name: "FreshGuard Core v${{ steps.extract_version.outputs.version }}"
          body: |
            # FreshGuard Core v${{ steps.extract_version.outputs.version }}

            ## Security Features âœ…

            - **Package Integrity**: Signed with cosign using keyless signing
            - **Supply Chain Security**: SBOM included for transparency
            - **Vulnerability Scanning**: Scanned for known vulnerabilities
            - **Open Source**: MIT licensed, no proprietary dependencies

            ## Installation

            ```bash
            pnpm install @freshguard/freshguard-core@${{ steps.extract_version.outputs.version }}
            ```

            ## Security Verification

            Verify package signature:
            ```bash
            # Download signature bundle from this release
            cosign verify-blob --bundle freshguard-freshguard-core-${{ steps.extract_version.outputs.version }}.tgz.cosign.bundle \
              --certificate-identity-regexp=".*" \
              --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
              freshguard-freshguard-core-${{ steps.extract_version.outputs.version }}.tgz
            ```

            ## What's Changed

          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            *.tgz
            *.bundle
            sbom-cyclonedx.json
            sbom-spdx.json
            SBOM.md

  version-docs:
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library (for TypeDoc)
        run: pnpm build

      - name: Install docs dependencies
        working-directory: website
        run: pnpm install

      - name: Extract minor version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          MINOR=$(echo "$VERSION" | sed 's/\.[0-9]*$//')
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "Versioning docs as $MINOR"

      - name: Snapshot docs version
        working-directory: website
        run: |
          if grep -q "\"${{ steps.version.outputs.minor }}\"" versions.json 2>/dev/null; then
            echo "Docs version ${{ steps.version.outputs.minor }} already exists, skipping (patch release)"
          else
            pnpm docusaurus docs:version ${{ steps.version.outputs.minor }}
          fi

      - name: Commit versioned docs to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add website/versioned_docs/ website/versioned_sidebars/ website/versions.json
          git diff --cached --quiet && echo "No doc changes to commit (patch release)" && exit 0
          git commit -m "docs: snapshot v${{ steps.version.outputs.minor }} documentation"
          git push origin main

  verify-published:
    needs: publish
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Wait for npm propagation
        run: sleep 60

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Test published packages
        run: |
          mkdir test-install
          cd test-install
          echo '{"name":"test-install","version":"1.0.0","type":"module"}' > package.json

          echo "Testing published packages..."
          pnpm install --ignore-scripts @freshguard/freshguard-core@${{ needs.publish.outputs.version }}

          node -e "
            import('@freshguard/freshguard-core').then(({ checkFreshness, createDatabase }) => {
              console.log('âœ… Published package works correctly');
              console.log('âœ… checkFreshness:', typeof checkFreshness);
              console.log('âœ… createDatabase:', typeof createDatabase);
            }).catch(err => {
              console.error('âŒ Failed to import package:', err.message);
              process.exit(1);
            });
          "
        env:
          version: ${{ needs.publish.outputs.version }}